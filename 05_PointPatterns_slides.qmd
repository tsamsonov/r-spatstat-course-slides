---
title: "Точечные процессы"
subtitle: "Пространственная статистика"
date: today
date-format: long
author: "Самсонов Тимофей Евгеньевич"
execute:
  echo: false
  freeze: true
engine: knitr
format:
  revealjs: 
    theme: [default, custom.scss]
    margin: 0.2
    width: 1280
    height: 720
    slide-number: true
    footer: "Самсонов Т. Е. Пространственная статистика: курс лекций"
    header-includes: <link rel="stylesheet" media="screen" href="https://fontlibrary.org//face/pt-sans" type="text/css"/>
bibliography: references.yaml
mainfont: PT Sans
---

## Точечный паттерн

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
library(tidyverse)
library(raster)
library(spatstat)
library(stars)
library(tmap)
library(sf)
library(sp)
```

**Точечный паттерн** *(point pattern)* представляет собой множество точек в $\mathbb{R}^2$, обозначаемое *малой* жирной буквой:

$$\mathbf{x} = \{x_1, x_2,...x_n\}$$ - Количество точек $n = n(\mathbf{x})$ может быть любым неотрицательным числом

-   Множество является неупорядоченным (индексы чисто условны)

-   Допускаются дубликаты (совпадающие точки), однако большинство методов рассчитаны на то, что дубликатов в множестве нет.

## Точечный паттерн

Если $\mathbf{x}$ представляет точечный паттерн и $B$ — это некий регион, то $\mathbf{x} \cap B$ есть подмножество $\mathbf{x}$, состоящее из точек, попадающих в $B$:

![:scale 40%](images/pregion.png)

В данном случае количество точек, попадающих в $B$, равняется $n = n(\mathbf{x} \cap B)$

## Точечные процессы

> \_\_ Точечным процессом\_\_ называется случайный процесс, реализациями которого являются точечные паттерны

**Конечный точечный процесс** *(finite point process)* — это точечный процесс, каждая реализация которого представляет собой точечный паттерн с конечным числом точек. При этом для любой области $B$ количество точек $\mathbf{x} \cap B$ представляет собой случайную величину с определимыми параметрами.

**Локально конечный точечный процесс** имеет конечное число точек в любой ограниченной области $B$ (более мягкое утверждение). Реализацией такого процесса является *локально конечный точечный паттерн*.

## Равномерно случайные точки

Простейшим точечным процессом является процесс $U = (U_1, U_2)$, каждая реализация которого включает одну точку $u = (u_1, u_2)$.

Случайная точка будет *равномерно* распределена в пространственной области $W$, если ее координаты $(U_1, U_2)$ имеют совместную плотность распределения, которая постоянна в пределах $W$ и равна нулю за ее пределами.

Поскольку интеграл плотности распределения равен 1, величина постоянной будет равна $1/|W|$:

$$f(u_1, u_2) = \begin{cases}
  1/|W|,~\text{если}~(u_1, u_2) \in W\\
  0, ~\text{в противном случае}
\end{cases}$$

## Равномерно случайные точки

Если $B$ представляет собой тестовую область в $W$, то вероятность того, что точка $U$ попадет в $B$, будет равна:

$$\mathbb{P}\{U \in B \} = \int_B f(u_1, u_2) du_1 du_2 = \\ = \frac{1}{|W|} \int_B 1 du_1 du_2 = \frac{|B|}{|W|}$$ - эта вероятность равна доле площади $B$ в $W$

-   вероятность зависит только от площади, и не зависит от положения и формы области $B$

## Биномиальный точечный процесс

**Биномиальным** называется точечный процесс $\mathbf{X} = \{X_1,..., X_n\}$, реализации которого содержат $n$ точек.

![Baddeley et. al., 2016](images/pbinomial.png)

Чтобы точки были распределены равномерно по пространству, необходимо выполнение двух условий:

-   $X_1,...,X_n$ представляют собой *независимые* случайные величины
-   Каждая из этих величин *равномерно* распределена в пределах $W$.

## Биномиальный точечный процесс

Если $B$ представляет собой тестовую область, то количество $n(\mathbf{X} \cap B)$ случайных точек, попавших в $B$, будет равняться количеству индексов $i$ таких, что $X_i \in B$.

Чтобы определить вероятностное распределение $n(\mathbf{X} \cap B)$, рассмотрим эту величину как количество успешных исходов в $n$ независимых испытаниях. Будем считать «успехом» исход, при котором случайная точка $X_i$ попадает в $B$.

Если испытания независимы и равномерно распределены, то вероятность успеха равна $p = |B| / |W|$ и величина $n(\mathbf{X} \cap B)$ имеет *биномиальный закон распределения*:

$$\mathbb{P}\{n(\mathbf{X} \cap B) = k\} = 
  \left(
    \begin{array}{c}
      n \\
      k
    \end{array}
  \right) p^k (1-p)^{n-k}\color{grey}{, k = 0, 1, ..., n}$$

Биномиальный коэффициент равен $\left(\begin{array}{c} n \\ k \end{array} \right) = \frac{n!}{(n-k)!~k!}$

## Пуассоновский процесс

**Однородный пуассоновский точечный процесс** (homogeneous Poisson point process), или *абсолютная пространственная случайность* (complete spatial randomness — CSR) характеризуется следующими свойствами:

-   **гомогенность**: размещение точек не имеет пространственных закономерностей
-   **независимость**: результат реализации процесса в одной области не оказывает влияние на результат реализации в других областях

![Baddeley et. al., 2016](images/ppoisson.png)

## Пуассоновский процесс

**Однородность** *(гомогенность)* означает, что ожидаемое количество точек, попадающих в регион $B$ должно быть пропорционально его площади:

$$\operatorname E[n(\mathbf{X} \cap B)] = \lambda |B|$$ Параметр $\lambda$ представляет собой среднее количество точек на единицу площади — **интенсивность точечного процесса**.

> В отличие от биномиального процесса, полностью случайный (Пуассоновский) процесс характеризуется *случайным количеством точек*.

## Пуассоновский процесс

**Пространственная независимость** означает, что количества точек в двух неперекрывающихся областях $A$ и $B$ являются независимыми случайными переменными:

$$n(\mathbf{X} \cap A) \not\sim n(\mathbf{X} \cap B),~A \cap B = \emptyset$$ \> Для биномиального процесса условие независимости не выполняется, поскольку известно общее количество точек. Если в область $A$ попало $k$ точек, то в область $B$ не может попасть более чем $n-k$ точек, что нарушает условие независимости распределений.

Предположение о независимости выполняется для любых непересекающихся регионов $A$ и $B$ и для любого числа этих регионов

## Пуассоновский процесс

Одним из следствий независимости является тот факт, что количество точек, подсчитанное по *регулярной сетке квадратов*, также даст совокупность независимых величин (для любого размера сетки):

![Baddeley et. al., 2016](images/qcounts.png)

## Пуассоновский процесс

**Упорядоченность** *(orderliness)*: при стремлении площади области к нулю, вероятность нахождения в этой области более одной точки, деленная на площадь, также стремится к нулю

![:scale 50%](images/smalltrials.png)

## Пуассоновский процесс

Если реализации отвечают условию независимости и вероятность нахождения более одной точки в бесконечно малом квадрате пренебрежимо мала, то случайную величину $n(\mathbf{X} \cap B)$ можно рассматривать как *количество «успехов» в большом числе независимых испытаний, каждое из которых имеет малую вероятность успеха*.

Это означает, что $n(\mathbf{X} \cap B)$ подчиняется **распределению Пуассона**, которое характеризует *частоту редких событий*.

В соответствии с этим законом, вероятность получить $k$ редких событий равна

$$\mathbb{P}\{N = k\} = e^{-\mu} \frac{\mu^k}{k!}\color{grey}{,~k = 0, 1, 2, ...}$$

Величина $\mu$ представляет собой *математическое ожидание* распределения Пуассона.

## Пуассоновский процесс

$$\mathbb{P}\{N = k\} = e^{-\mu} \frac{\mu^k}{k!}\color{grey}{,~k = 0, 1, 2, ...}$$

Величина $\mu$ представляет собой *математическое ожидание* распределения Пуассона.

> Дисперсия распределения Пуассона равна его математическому ожиданию

Поскольку, как мы показали ранее, ожидаемое количество точек в регионе $B$ равняется $\operatorname E[n(\mathbf{X} \cap B)] = \lambda |B|$, можно сделать вывод, что случайная величина $n(\mathbf{X} \cap B)$ имеет распределение Пуассона с математическим ожиданием:

$$\mu = \lambda |B|$$

## Пуассоновский процесс

Пуассоновский процесс определяется следующими **параметрами**:

-   **однородность**: количество $n(\mathbf{X} \cap B)$ случайных точек, попадающих в выборочную область $B$ характеризуется мат. ожиданием $\mathbb{E}n(\mathbf{X} \cap B) = \lambda |B|$;

-   **независимость**: для неперекрывающихся выборочных областей $B_1, B_2, ..., B_k$, количества $n(\mathbf{X} \cap B_1), ..., n(\mathbf{X} \cap B_k)$ предствляют собой независимые случайные величины;

-   **распределение Пуассона**: число $n(\mathbf{X} \cap B)$ случайных точек, попадающих в выборочную область $B$ распределено по закону Пуассона.

## Пуассоновский процесс

**Свойства** пуассоновского процесса:

-   **условность** *(conditional)*: в любой области $B$ точки процесса независимо и равномерно распределены;

-   **прореживаемость** *(thinning)*: при случайном прореживании (отборе точек) пуассоновского точечного паттерна с интенсивностью $\lambda$ результирующий паттерн будет соответствовать Пуассоновскому процессу с интенсивностью $p\lambda$, где $p$ — вероятность сохранения точки (процент отбора);

    ![Baddeley et. al., 2016](images/pthinning.png)

## Пуассоновский процесс

**Свойства** пуассоновского процесса:

-   **суперпозиция** *(superposition)*: сумма двух независимых гомогенных случайных точечных процессов $Z = X \cup Y$ с интенсивностями $\lambda_X$ и $\lambda_Y$ является гомогенным Пуассоновским процессом с интенсивностью $\lambda_Z = \lambda_X + \lambda_Y$

    ![Baddeley et. al., 2016](images/psuperposition.png)

## Симуляция Пуассоновского процесса

Пусть дана область $B = [x_{min}, x_{max}] \times [y_{min}, y_{max}]$ и интенсивность точечного процесса $\lambda$.

1.  Сгенерировать случайное число $N$, имеющее распределение Пуассона с параметром $\mu = \lambda |B|$.

2.  Сгенерировать $N$ координат $X$, имеющих равномерное распределение на промежутке $[x_{min}, x_{max}]$.

3.  Сгенерировать $N$ координат $Y$, имеющих равномерное распределение на промежутке $[y_{min}, y_{max}]$.

> Вероятность получить 0 точек также существует и равна $\mathbb{P}\{N = 0\} = e^{-\mu} \frac{\mu^0}{0!} = e^{-\lambda |B|}$

## Неоднородный пуассоновский процесс

Определяется следующими параметрами:

-   **функция интенсивности**: количество $n(\mathbf{X} \cap B)$ случайных точек, попадающих в выборочную область $B$ характеризуется мат. ожиданием $\mathbb{E}n(\mathbf{X} \cap B) = \int_B \lambda(u) du = \mu$, где $\lambda(u)$ есть пространственная функция интенсивности;

-   **независимость**: для неперекрывающихся выборочных областей $B_1, B_2, ..., B_k$, количества $n(\mathbf{X} \cap B_1), ..., n(\mathbf{X} \cap B_k)$ предствляют собой независимые случайные величины;

-   **распределение Пуассона**: число $n(\mathbf{B} \cap B)$ случайных точек, попадающих в выборочную область $B$ распределено по закону Пуассона.

## Неоднородный пуассоновский процесс

Данные параметры отличаются следующими свойствами:

-   функция плотности $\lambda(u)$ определяет общее количество точек и их пространственное распределение;

-   никаких ограничений на функцию $\lambda(u)$ не накладывается, вследствие этого модель неоднородного Пуассоновского процесса является достаточно общей;

-   свойства условности, прореживаемости и суперпозиции справедливы также и для неоднородного пуассоновского процесса;

## Симуляция неоднородного пуассоновского процесса

Метод *Льюиса-Шедлера* (Lewis-Shedler thinning):

1.  Генерируется однородный Пуассоновской процесс с интенсивностью $M = \max_L\big[\lambda(u)\big]$.

2.  Осуществляется случайное прореживание (исключение) точек с вероятностью сохранения точки $p(u) = \lambda(u) / M$, пропорциональной функции интенсивности.

Чтобы понять, будет ли точка исключена, генерируется случайное число 0 или 1, имеющее распределение Бернулли с вероятностью положительного исхода $p = p(u)$. Это можно сделать с помощью функции `rbinom(1, 1, p)`

## Симуляция неоднородного пуассоновского процесса

$$\lambda(x,y) = x + y^2$$

```{r, echo = FALSE, fig.width=10, fig.height=5, dpi=300}
lambda = function(x,y) { 500 * (y^2 + x) }

U = rpoispp(lambda, win=square(1))

par(mfrow = c(1,2))
plot(U, pch = 20)
plot(density(U))
```

## Процесс Кокса (Cox process)

Процесс Кокса определяется как Пуассоновский процесс со случайной функцией интенсивности $\Lambda(u)$, которая называется *порождающей интенсивностью*

![Baddeley et. al., 2016](images/cox.png)

Слева — реализация случайной функции $\Lambda(u)$. По центру — реализация Пуассоновского точечного процесса с интенсивностью $\Lambda(u)$.

## Процесс Кокса (Cox process)

-   **Cмешанный Пуассоновский процесс**: однородный Пуассоновский процесс, порождаемый постоянной случайной величиной $\Lambda$. Интенсивность процесса равна $\lambda = \mathbb E\Lambda$.

-   **Логнормальный процесс Кокса**: процесс Кокса с порождающей интенсивностью, равной $\Lambda(u) = \exp\big[G(u)\big]$, где $G(u)$ — Гауссовское случайное поле.

Для *гауссовского случайного поля* в каждой точке $u_i$ случайная величина $G(u_i)$ имеет нормальное распределение, для пары точек $u$ и $v$ пара величин $\big(G(u), G(v)\big)$ имеет двумерное нормальное распределение. Аналогично и для произвольного числа точек.

## Процесс Кокса (Cox process)

Независимые реализации логнормального процесса Кокса:

![Baddeley et. al., 2016](images/coxnormal.png)

## Кластерные процессы

1.  Генерируется «родительский» точечный процесс $\mathbf{Y}$.

2.  Каждая точка родительского процесса $y_i$ порождает случайный точечный паттерн «потомков» $x_{ij}$

![Baddeley et. al., 2016](images/clustered.png)

## Кластерные процессы

— Наблюдаются только точки потомков (каждая родительская точка замещается ее потомками).

— Множество точек $x_{ij}$ формирует реализацию кластерного точечного процесса $\mathbf{X}$.

![Baddeley et. al., 2016](images/clustered.png)

## Кластерные процессы

Возможные свойства кластерных процессов:

-   (CLP1) **пуассоновские родители**: родительские точки являются реализацией Пуассоновского процесса.

-   (CLP2) **независимые кластеры**: кластеры независимы друг от друга.

-   (CLP3) **идентично распределенные кластеры**: если совместить разные кластеры, то они будут иметь одно распределение.

-   (CLP4) **независимые потомки**: потомки внутри каждого кластера независимы и одинаково распределены.

Процессы, отвечающие требованиям (CLP1)—(CLP4) носят название процессов **Неймана-Скотта** (*Neyman-Scott*).

## Кластерные процессы

-   (CLP5) **пуассоновское количество потомков**: для каждой родительской точки количество потомков есть пуассоновская случайная величина.

-   (CLP6) **изотропные кластеры**: плотность распределения потомков зависит только от расстояния до родительской точки.

## Кластерные процессы

-   Процесс Матерна $(\kappa, \mu, r)$: процесс $Y$ имеет интенсивность $κ$, каждый родитель имеет $Π(μ)$ потомков, случайно распределенных в радиусе $r$

-   Процесс Томаса $(\kappa, \mu, \sigma)$: процесс $Y$ имеет интенсивность κ, каждый родитель имеет $Π(μ)$ потомков, смещенных на расстояние, подчиняющееся распределению $N(0,\sigma^2)$

## Кластерные процессы

Реализации процесса Матерна в квадрате $[0, 1] \times [0, 1]$ с интенсивностью родителей $\kappa = 8$, средним количеством потомков $\mu = 5$ и радиусом кластера $R = 0.1$:

![Baddeley et. al., 2016](images/matern.png)

## Регулярные процессы

Точки не могут располагаться на расстоянии ближе чем $r$ — **расстояния ингибиции** (отталкивания).

-   **Последовательные модели**: точки генерируются последовательно согласно Пуассоновскому распредедению (координаты равномерно распределены). Каждая последующая точка сохраняется, только если она находится на расстоянии не ближе, чем $r$.

-   **Зависимое прореживание**: генерируется Пуассоновский процесс. После этого удаляются точки, расположенные на расстоянии меньшем $r$. Пары близко расположенных точек аннигилируют (*процесс Матерна I*). Либо точки маркируются случайным «временем прибытия» и удаляется точка, имеющая более позднее время прибытия (*процесс Матерна II*).

## Регулярные процессы

**Последовательная модель**:

![:scale 60%](images/rssi.png)

## Регулярные процессы

**Процесс Матерна I**:

![Baddeley et. al., 2016](images/matern1.png)

## Регулярные процессы

**Процесс Матерна II**:

![Baddeley et. al., 2016](images/matern2.png)
